<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ–‡ä»¶æè¿°ç¬¦ | BouseBlog</title>
<link rel="shortcut icon" href="https://bouse-w.github.io/BouseBlog.github.io//favicon.ico?v=1742972353564">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://bouse-w.github.io/BouseBlog.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="æ–‡ä»¶æè¿°ç¬¦ | BouseBlog - Atom Feed" href="https://bouse-w.github.io/BouseBlog.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="è‚¾æ‘¸æ˜¯æ–‡ä»¶æè¿°ç¬¦


ä¸€åˆ‡çš†æ–‡ä»¶
ï¼šå°†æ™®é€šæ–‡ä»¶ï¼Œé“¾æ¥æ–‡ä»¶ï¼ŒSocket ä»¥åŠè®¾å¤‡é€šè¿‡ç›®å½•ç»Ÿä¸€åœ¨ä¸€ä¸ªé€’å½’çš„æ ‘å½¢ç»“æ„ä¸­ï¼Œå½¢æˆäº†ä¸€ä¸ªç»Ÿä¸€çš„å‘½åç©ºé—´
ã€ŠThe Unix TimeSharing Systemã€‹
PSï¼šåœ¨ UNIX ç³»ç»Ÿä¸­ï¼Œâ€˜ä¸€åˆ‡çš†æ–‡..." />
    <meta name="keywords" content="System_programming" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://bouse-w.github.io/BouseBlog.github.io/">
  <img class="avatar" src="https://bouse-w.github.io/BouseBlog.github.io//images/avatar.png?v=1742972353564" alt="">
  </a>
  <h1 class="site-title">
    BouseBlog
  </h1>
  <p class="site-description">
    è®©æˆ‘ä»¬é‡æ–°å¼€å§‹
  </p>
  <div class="menu-container">
    
      
        <a href="https://bouse-w.github.io/BouseBlog.github.io/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="https://bouse-w.github.io/BouseBlog.github.io/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="https://bouse-w.github.io/BouseBlog.github.io/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="https://bouse-w.github.io/BouseBlog.github.io/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              æ–‡ä»¶æè¿°ç¬¦
            </h2>
            <div class="post-info">
              <span>
                2025-03-18
              </span>
              <span>
                6 min read
              </span>
              
                <a href="https://bouse-w.github.io/BouseBlog.github.io/tag/6in0akQ6Fb/" class="post-tag">
                  # System_programming
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <h4 id="è‚¾æ‘¸æ˜¯æ–‡ä»¶æè¿°ç¬¦">è‚¾æ‘¸æ˜¯æ–‡ä»¶æè¿°ç¬¦</h4>
<ul>
<li>
<p>ä¸€åˆ‡çš†æ–‡ä»¶</p>
<p>ï¼šå°†æ™®é€šæ–‡ä»¶ï¼Œé“¾æ¥æ–‡ä»¶ï¼ŒSocket ä»¥åŠè®¾å¤‡é€šè¿‡ç›®å½•ç»Ÿä¸€åœ¨ä¸€ä¸ªé€’å½’çš„æ ‘å½¢ç»“æ„ä¸­ï¼Œå½¢æˆäº†ä¸€ä¸ªç»Ÿä¸€çš„å‘½åç©ºé—´</p>
<p>ã€ŠThe Unix TimeSharing Systemã€‹</p>
<p>PSï¼šåœ¨ UNIX ç³»ç»Ÿä¸­ï¼Œâ€˜ä¸€åˆ‡çš†æ–‡ä»¶â€™çš„è´¯å½»ç¨‹åº¦å¹¶ä¸é«˜ï¼Œä¸€äº›æœºåˆ¶çš„å­˜åœ¨ä½¿ UNIX ä¸­çš„â€˜ä¸€åˆ‡çš†æ–‡ä»¶â€™é€€åŒ–æˆäº†â€˜ä¸€åˆ‡çš†æ–‡ä»¶æè¿°ç¬¦â€™ã€‚ç¥–å¸ˆçˆ·é‡Œå¥‡åœ¨åæ¥çš„ Plan 9 åˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿä¸­å†æ¬¡å¯¹è¿™ä¸€æœ´ç´ æ€æƒ³è¿›è¡Œäº†å°è¯•ï¼Œå¹¶æœ€ç»ˆç”± Linus åœ¨ Linux ç³»ç»Ÿä¸­å®ç°äº†â€˜ä¸€åˆ‡çš†æ–‡ä»¶â€™çš„ç¾å¥½æ„¿æ™¯</p>
</li>
<li>
<p>Linux ä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦æ˜¯å†…æ ¸ä¸ºäº†é«˜æ•ˆç®¡ç†å·²è¢«æ‰“å¼€çš„æ–‡ä»¶æ‰€åˆ›å»ºçš„ç´¢å¼•ï¼Œç”¨ä»¥æŒ‡ä»£è¢«æ‰“å¼€çš„æ–‡ä»¶ã€‚æ‰€æœ‰å¯¹æ–‡ä»¶çš„ I/O æ“ä½œéƒ½éœ€è¦ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦</p>
</li>
</ul>
<h4 id="æ–‡ä»¶æè¿°ç¬¦çš„å®ç°å’Œåº”ç”¨">æ–‡ä»¶æè¿°ç¬¦çš„å®ç°å’Œåº”ç”¨</h4>
<ul>
<li>æ€»åœ°æ¥è¯´ï¼Œè¿›ç¨‹ä¸æ–‡ä»¶çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼ˆi-node ç»“æ„ä½“ä¸åœ¨æ­¤å›¾ï¼‰</li>
</ul>
<div align=center>
	<img src="https://raw.githubusercontent.com/Bouse-W/blog_images/main/BouseBlog/imgs/2023/11/è¿›ç¨‹ä½¿ç”¨æ–‡ä»¶çš„æµç¨‹-1.jpeg" alt="automatic-scalability" width=90%>
	<figcaption >
        <font size=2>è¿›ç¨‹ä½¿ç”¨æ–‡ä»¶çš„æµç¨‹</font>
    </figcaption>
</div>
<ul>
<li>
<p>æ–‡ä»¶æè¿°ç¬¦ä¸ç³»ç»Ÿè¿è¡Œçš„å…³ç³»</p>
<div align=center>
  <img src="https://raw.githubusercontent.com/Bouse-W/blog_images/main/BouseBlog/imgs/2023/11/æ–‡ä»¶æè¿°ç¬¦ä¸ç³»ç»Ÿè°ƒç”¨çš„å…³ç³».jpg" alt="automatic-scalability" width=70%>
  <figcaption >
      <font size=2>æ–‡ä»¶æè¿°ç¬¦ä¸ç³»ç»Ÿè°ƒç”¨çš„å…³ç³»</font>
  </figcaption>
</li>
</ul>
</div>
<ul>
<li>
<p>è¿›ç¨‹çº§åˆ«çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ (struct fdtable)</p>
<p>ï¼šå†…æ ¸ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œçœ‹çœ‹</p>
<p>æ–‡ä»¶æè¿°ç¬¦è¡¨ç»“æ„ä½“</p>
<p>çš„æºç </p>
<pre><code class="language-cpp">struct fdtable
{
unsigned int max_fds;
struct file __rcu **fd;      /* current fd_array*/
unsigned long * close_on_exec;
unsigned long * open_fds;
unsigned long * full_fds_bits;
struct rcu_head rcu;
};
</code></pre>
</li>
<li>
<p><strong>max_fds</strong>ï¼šæ­¤æ–‡ä»¶æè¿°ç¬¦è¡¨ç»“æ„ä½“ä¸­èƒ½å®¹çº³ fd çš„æœ€å¤§æ•°é‡</p>
</li>
<li>
<p><strong>struct file çš„äºŒé‡æŒ‡é’ˆ</strong>ï¼šæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œçš„å…ƒç´ æ˜¯ æ–‡ä»¶æè¿°ç»“æ„ (struct file) çš„æŒ‡é’ˆ</p>
</li>
<li>
<p>open_fdsï¼šlong å‹æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„æ¯ä¸€ä¸ª bit ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæ­¤æ–‡ä»¶å·² openï¼Œåˆ™æ­¤ bit ç½® 1ï¼›</p>
</li>
<li>
<p>close_on_execï¼šåŒ open_fds åŸç†ç›¸åŒï¼Œå«ä¹‰ä¸åŒï¼›</p>
</li>
<li>
<p>full_fds_bitsï¼šlong å‹æ•°ç»„ï¼Œè‹¥ open_fds é‡ŒæŸå…ƒç´ æ‰€æœ‰ bit éƒ½ä¸º 1ï¼Œæ­¤æ•°ç»„ä¸­å¯¹åº”çš„å…ƒç´ çš„ä¸€ä¸ª bit ç½® 1ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸ä¸º 1ï¼Œè¿™ä¸ª bit ç½® 0ï¼›</p>
</li>
</ul>
<p><strong>æ³¨ï¼šä¸Šè¿°ä»£ç å¹¶æœªè¯´æ˜æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå³ fd åˆ°åº•æ˜¯ä¸ªè‚¾æ‘¸æ ·å­çš„å˜é‡ï¼Œä¹Ÿæ²¡æœ‰è¡¨æ˜å¦‚ä½•åˆ›å»ºå’Œä½¿ç”¨ fdï¼Œä¸ºæ­¤ï¼Œä¸‹é¢çœ‹ä¸€æ®µç›´æ¥ä½¿ç”¨ fd è¿›è¡Œæ–‡ä»¶æ“ä½œçš„æºç ï¼š</strong></p>
<pre><code class="language-cpp">// close çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨äº† __close_fd å‡½æ•°
SYSCALL_DEFINE1 (close, unsigned int, fd)
{
  int retval = __close_fd (current-&gt;files, fd);

  /* can't restart close syscall because file table entry was cleared */
  if (unlikely (retval == -ERESTARTSYS ||
                retval == -ERESTARTNOINTR ||
                retval == -ERESTARTNOHAND ||
                retval == -ERESTART_RESTARTBLOCK))
  retval = -EINTR;

    return retval;
}
</code></pre>
<pre><code class="language-cpp">// __close_fd å‡½æ•°å®ç°ï¼Œé€šè¿‡ fd å…³é—­ open æ‰“å¼€çš„æ–‡ä»¶
int __close_fd(struct files_struct * files, unsigned fd)
{
  struct file * file;
  struct fdtable * fdt;

  spin_lock (&amp;files-&gt;file_lock);
  fdt = files_fdtable (files);      // è·å¾—æ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦è¡¨
  if (fd &gt;= fdt -&gt; max_fds)
    goto out_unlock;
  file = fdt -&gt; fd[fd];       // é€šè¿‡æ–‡ä»¶æè¿°ç¬¦è·å–æ–‡ä»¶æè¿°ç»“æ„çš„æŒ‡é’ˆ
  if (!file)
    goto out_unlock;
  rcu_assign_pointer (fdt -&gt; fd[fd], NULL);
  __put_unused_fd (files, fd);      // å›æ”¶æ–‡ä»¶æè¿°ç¬¦
  spin_unlock (&amp;files -&gt; file_lock);
  return filp_close (file, files);

out_unlock:
  spin_unlock (&amp;files -&gt; file_lock);
  return -EBADF;
}
EXPORT_SYMBOL (__close_fd); /* for ksys_close() */
</code></pre>
<ul>
<li>__close<em>fd</em> å‡½æ•°æ ¹æ®æè¿°ç¬¦ fdï¼Œåœ¨æ–‡ä»¶æè¿°ç¬¦è¡¨çš„<strong>æ–‡ä»¶æè¿°ç»“æ„çš„æŒ‡é’ˆæ•°ç»„ï¼Œå³ struct file _rcu</strong>  fd** ä¸­æ‰¾åˆ°è¦æ“ä½œçš„æ–‡ä»¶æè¿°æŒ‡é’ˆï¼Œç„¶åæ“ä½œæ–‡ä»¶ã€‚</li>
<li>è‡³æ­¤ï¼Œæˆ‘ä»¬çœ‹å‡ºï¼šæ–‡ä»¶æè¿°ç¬¦ fd æ˜¯æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­ï¼Œæ–‡ä»¶æè¿°ç»“æ„æŒ‡é’ˆæ•°ç»„çš„ç´¢å¼•å€¼ï¼Œå› æ­¤å®ƒéè´Ÿï¼Œä» 0 èµ·ã€‚</li>
<li><strong>ç³»ç»Ÿçº§åˆ«çš„æ‰“å¼€æ–‡ä»¶è¡¨ (files_struct)</strong>ï¼šå†…æ ¸å¯¹æ‰€æœ‰æ‰“å¼€æ–‡ä»¶ç»´æŠ¤çš„ï¼Œä¸€ä¸ªæ‰€æœ‰è¿›ç¨‹å…±äº«çš„æ‰“å¼€æ–‡ä»¶çš„æè¿°è¡¨ï¼Œæˆ‘ä»¬çœ‹çœ‹æºç  ğŸ¤¡</li>
</ul>
<pre><code class="language-cpp">/*
* Open file table structure
*/
struct files_struct
{
  /*
  * read mostly part
  */
  atomic_t count;         // æ‰“å¼€çš„æ–‡ä»¶æ•°
  bool resize_in_progress;
  wait_queue_head_t resize_wait;
  // fdtable ç»´æŠ¤ç€æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦
  struct fdtable __rcu * fdt;
  struct fdtable fdtab;
  /*
  * written part on a separate cache line in SMP
  */
  spinlock_t file_lock ____cacheline_aligned_in_smp;
  unsigned int next_fd;           // ä¸‹ä¸€ä¸ªå¯ç”¨æ–‡ä»¶æè¿°ç¬¦
  unsigned long close_on_exec_init[1];
  unsigned long open_fds_init[1];
  unsigned long full_fds_bits_init[1];
  struct file __rcu * fd_array[NR_OPEN_DEFAULT];
};
</code></pre>
<ul>
<li>ç³»ç»Ÿçº§åˆ«çš„ i-node è¡¨ï¼ši-node ç»“æ„ä½“è®°å½•äº†æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯</li>
<li><strong>æ–‡ä»¶æè¿°ç»“æ„ (struct file)</strong>ï¼šå…¶ä¸­è®°å½•äº†ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶çš„å„ç§ä¿¡æ¯ï¼Œå¦‚ <strong>æ–‡ä»¶çš„i-nodeï¼Œæ–‡ä»¶å½“å‰çš„è¯»å†™ä½ç½®ï¼Œæ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼ç­‰</strong>ï¼Œå®ƒæ˜¯è¿™æ ·çš„</li>
</ul>
<pre><code class="language-cpp">struct file
{
  union
  {
    struct llist_node   fu_llist;
    struct rcu_head     fu_rcuhead;
  } f_u;
  struct path       f_path;
  struct inode      *f_inode;   /* cached value */
  const struct file_operations  *f_op;

  /*
  * Protects f_ep_links, f_flags.
  * Must not be taken from IRQ context.
  */
  spinlock_t        f_lock;
  enum rw_hint      f_write_hint;
  atomic_long_t     f_count;
  unsigned int      f_flags;
  fmode_t           f_mode;
  struct mutex      f_pos_lock;
  loff_t            f_pos;
  struct fown_struct    f_owner;
  const struct cred *f_cred;
  struct file_ra_state  f_ra;

  u64           f_version;
#ifdef CONFIG_SECURITY
  void          *f_security;
#endif
  /* needed for tty driver, and maybe others */
  void          *private_data;
#ifdef CONFIG_EPOLL
  /* Used by fs/eventpoll.c to link all the hooks to this file */
  struct list_head  f_ep_links;
  struct list_head  f_tfile_llink;
#endif /* #ifdef CONFIG_EPOLL */
  struct address_space  *f_mapping;
  errseq_t      f_wb_err;
} __randomize_layout
__attribute__((aligned(4)));    /* lest something weird decides that 2 is OK */
</code></pre>
<ul>
<li>å¾ˆæ˜æ˜¾ï¼Œæˆ‘æ²¡æœ‰å†™<strong>è¿›ç¨‹ç»“æ„ä½“ (struct task_struct)</strong> ğŸ¤¡</li>
</ul>
<h4 id="å’Œæ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ç»ˆç«¯å‘½ä»¤">å’Œæ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ç»ˆç«¯å‘½ä»¤</h4>
<ul>
<li><strong>cat /proc/sys/fs/file-max</strong>ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹å…è®¸æŒæœ‰çš„æœ€å¤§ fd æ•°é‡</li>
<li><strong>ulimit -n</strong>ï¼šæŸ¥çœ‹å•ä¸ªè¿›ç¨‹å…è®¸çš„æœ€å¤§ fd æ•°é‡</li>
<li><strong>cat /proc/sys/fs/file-nr</strong>ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹å·²ç»æ‰“å¼€çš„ fd æ•°é‡ä»¥åŠå…è®¸çš„æœ€å¤§æ•°é‡</li>
<li><strong>lsof -p pid</strong>ï¼šé€šè¿‡è¿›ç¨‹å·ï¼ŒæŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶åŠå…¶ fd</li>
<li>å·²ç»æ‰“å¼€çš„è¿›ç¨‹éƒ½ä»¥ç›®å½•å½¢å¼å­˜æ”¾åœ¨ /proc ç›®å½•ä¸­ï¼Œå¯ä»¥é€šè¿‡ /proc/{pid}/fd æŸ¥çœ‹è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶åŠå…¶ fd</li>
<li><strong>pgrep {å¯æ‰§è¡Œæ–‡ä»¶å}</strong>ï¼šæŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„æ–‡ä»¶çš„è¿›ç¨‹å·</li>
</ul>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#%E8%82%BE%E6%91%B8%E6%98%AF%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6">è‚¾æ‘¸æ˜¯æ–‡ä»¶æè¿°ç¬¦</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%92%8C%E5%BA%94%E7%94%A8">æ–‡ä»¶æè¿°ç¬¦çš„å®ç°å’Œåº”ç”¨</a></li>
<li><a href="#%E5%92%8C%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%9B%B8%E5%85%B3%E7%9A%84%E7%BB%88%E7%AB%AF%E5%91%BD%E4%BB%A4">å’Œæ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ç»ˆç«¯å‘½ä»¤</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://bouse-w.github.io/BouseBlog.github.io/post/shu-ju-jian-yan-yu-jiu-cuo-crcchecksumhan-ming-ma-qi-ou-xiao-yan-wei/">
              <h3 class="post-title">
                æ•°æ®æ£€éªŒä¸çº é”™â€”â€”CRCã€Checksumã€æ±‰æ˜ç ã€å¥‡å¶æ ¡éªŒä½
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  <p><font size=1>åŸåšå®¢ç½‘ç«™ rerevolution.cnï¼ˆæœåŠ¡å™¨è¿‡æœŸäº†ï¼‰çš„é‡å»º</font></p>
  <a class="rss" href="https://bouse-w.github.io/BouseBlog.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
